"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const s3Client = new client_s3_1.S3Client({ region: process.env.AWS_REGION });
const NOTES_BUCKET = process.env.NOTES_BUCKET;
const NOTES_PREFIX = process.env.NOTES_PREFIX || '';
const handler = async (event) => {
    try {
        // Extract user ID from Cognito JWT token
        const userId = event.requestContext.authorizer?.claims?.sub;
        if (!userId) {
            return {
                statusCode: 401,
                headers: {
                    'Access-Control-Allow-Origin': 'https://ougotti.github.io',
                    'Access-Control-Allow-Headers': 'Content-Type,Authorization',
                },
                body: JSON.stringify({ error: 'Unauthorized' }),
            };
        }
        const httpMethod = event.httpMethod;
        const resource = event.resource;
        // Sanitize user ID to prevent path traversal
        const sanitizedUserId = userId.replace(/[^a-zA-Z0-9-]/g, '');
        const userPrefix = `${NOTES_PREFIX}${sanitizedUserId}/`;
        switch (`${httpMethod} ${resource}`) {
            case 'GET /notes':
                return await listNotes(userPrefix);
            case 'POST /notes':
                return await createNote(userPrefix, JSON.parse(event.body || '{}'));
            case 'GET /notes/{noteId}':
                return await getNote(userPrefix, event.pathParameters?.noteId);
            case 'PUT /notes/{noteId}':
                return await updateNote(userPrefix, event.pathParameters?.noteId, JSON.parse(event.body || '{}'));
            case 'DELETE /notes/{noteId}':
                return await deleteNote(userPrefix, event.pathParameters?.noteId);
            default:
                return {
                    statusCode: 405,
                    headers: {
                        'Access-Control-Allow-Origin': 'https://ougotti.github.io',
                        'Access-Control-Allow-Headers': 'Content-Type,Authorization',
                    },
                    body: JSON.stringify({ error: 'Method not allowed' }),
                };
        }
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: {
                'Access-Control-Allow-Origin': 'https://ougotti.github.io',
                'Access-Control-Allow-Headers': 'Content-Type,Authorization',
            },
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
async function listNotes(userPrefix) {
    const command = new client_s3_1.ListObjectsV2Command({
        Bucket: NOTES_BUCKET,
        Prefix: userPrefix,
    });
    const response = await s3Client.send(command);
    const notes = await Promise.all((response.Contents || []).map(async (object) => {
        const noteId = object.Key.replace(userPrefix, '').replace('.json', '');
        const getCommand = new client_s3_1.GetObjectCommand({
            Bucket: NOTES_BUCKET,
            Key: object.Key,
        });
        const noteResponse = await s3Client.send(getCommand);
        const noteContent = await noteResponse.Body.transformToString();
        const note = JSON.parse(noteContent);
        return {
            id: noteId,
            title: note.title,
            createdAt: note.createdAt,
            updatedAt: note.updatedAt,
        };
    }));
    return {
        statusCode: 200,
        headers: {
            'Access-Control-Allow-Origin': 'https://ougotti.github.io',
            'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        },
        body: JSON.stringify({ notes }),
    };
}
async function createNote(userPrefix, noteData) {
    const noteId = generateNoteId();
    const now = new Date().toISOString();
    const note = {
        id: noteId,
        title: noteData.title || 'Untitled',
        content: noteData.content || '',
        createdAt: now,
        updatedAt: now,
    };
    const command = new client_s3_1.PutObjectCommand({
        Bucket: NOTES_BUCKET,
        Key: `${userPrefix}${noteId}.json`,
        Body: JSON.stringify(note),
        ContentType: 'application/json',
    });
    await s3Client.send(command);
    return {
        statusCode: 201,
        headers: {
            'Access-Control-Allow-Origin': 'https://ougotti.github.io',
            'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        },
        body: JSON.stringify({ note }),
    };
}
async function getNote(userPrefix, noteId) {
    if (!noteId) {
        return {
            statusCode: 400,
            headers: {
                'Access-Control-Allow-Origin': 'https://ougotti.github.io',
                'Access-Control-Allow-Headers': 'Content-Type,Authorization',
            },
            body: JSON.stringify({ error: 'Note ID is required' }),
        };
    }
    // Sanitize note ID
    const sanitizedNoteId = noteId.replace(/[^a-zA-Z0-9-]/g, '');
    try {
        const command = new client_s3_1.GetObjectCommand({
            Bucket: NOTES_BUCKET,
            Key: `${userPrefix}${sanitizedNoteId}.json`,
        });
        const response = await s3Client.send(command);
        const noteContent = await response.Body.transformToString();
        const note = JSON.parse(noteContent);
        return {
            statusCode: 200,
            headers: {
                'Access-Control-Allow-Origin': 'https://ougotti.github.io',
                'Access-Control-Allow-Headers': 'Content-Type,Authorization',
            },
            body: JSON.stringify({ note }),
        };
    }
    catch (error) {
        if (error.name === 'NoSuchKey') {
            return {
                statusCode: 404,
                headers: {
                    'Access-Control-Allow-Origin': 'https://ougotti.github.io',
                    'Access-Control-Allow-Headers': 'Content-Type,Authorization',
                },
                body: JSON.stringify({ error: 'Note not found' }),
            };
        }
        throw error;
    }
}
async function updateNote(userPrefix, noteId, noteData) {
    if (!noteId) {
        return {
            statusCode: 400,
            headers: {
                'Access-Control-Allow-Origin': 'https://ougotti.github.io',
                'Access-Control-Allow-Headers': 'Content-Type,Authorization',
            },
            body: JSON.stringify({ error: 'Note ID is required' }),
        };
    }
    // Sanitize note ID
    const sanitizedNoteId = noteId.replace(/[^a-zA-Z0-9-]/g, '');
    try {
        // Get existing note
        const getCommand = new client_s3_1.GetObjectCommand({
            Bucket: NOTES_BUCKET,
            Key: `${userPrefix}${sanitizedNoteId}.json`,
        });
        const response = await s3Client.send(getCommand);
        const noteContent = await response.Body.transformToString();
        const existingNote = JSON.parse(noteContent);
        // Update note
        const updatedNote = {
            ...existingNote,
            ...noteData,
            id: existingNote.id,
            createdAt: existingNote.createdAt,
            updatedAt: new Date().toISOString(),
        };
        const putCommand = new client_s3_1.PutObjectCommand({
            Bucket: NOTES_BUCKET,
            Key: `${userPrefix}${sanitizedNoteId}.json`,
            Body: JSON.stringify(updatedNote),
            ContentType: 'application/json',
        });
        await s3Client.send(putCommand);
        return {
            statusCode: 200,
            headers: {
                'Access-Control-Allow-Origin': 'https://ougotti.github.io',
                'Access-Control-Allow-Headers': 'Content-Type,Authorization',
            },
            body: JSON.stringify({ note: updatedNote }),
        };
    }
    catch (error) {
        if (error.name === 'NoSuchKey') {
            return {
                statusCode: 404,
                headers: {
                    'Access-Control-Allow-Origin': 'https://ougotti.github.io',
                    'Access-Control-Allow-Headers': 'Content-Type,Authorization',
                },
                body: JSON.stringify({ error: 'Note not found' }),
            };
        }
        throw error;
    }
}
async function deleteNote(userPrefix, noteId) {
    if (!noteId) {
        return {
            statusCode: 400,
            headers: {
                'Access-Control-Allow-Origin': 'https://ougotti.github.io',
                'Access-Control-Allow-Headers': 'Content-Type,Authorization',
            },
            body: JSON.stringify({ error: 'Note ID is required' }),
        };
    }
    // Sanitize note ID
    const sanitizedNoteId = noteId.replace(/[^a-zA-Z0-9-]/g, '');
    try {
        const command = new client_s3_1.DeleteObjectCommand({
            Bucket: NOTES_BUCKET,
            Key: `${userPrefix}${sanitizedNoteId}.json`,
        });
        await s3Client.send(command);
        return {
            statusCode: 204,
            headers: {
                'Access-Control-Allow-Origin': 'https://ougotti.github.io',
                'Access-Control-Allow-Headers': 'Content-Type,Authorization',
            },
            body: '',
        };
    }
    catch (error) {
        console.error('Error deleting note:', error);
        return {
            statusCode: 500,
            headers: {
                'Access-Control-Allow-Origin': 'https://ougotti.github.io',
                'Access-Control-Allow-Headers': 'Content-Type,Authorization',
            },
            body: JSON.stringify({ error: 'Failed to delete note' }),
        };
    }
}
function generateNoteId() {
    return `note-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxrREFBNkg7QUFHN0gsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztBQUNsRSxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQWEsQ0FBQztBQUMvQyxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUM7QUFVN0MsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEtBQTJCLEVBQWtDLEVBQUU7SUFDM0YsSUFBSTtRQUNGLHlDQUF5QztRQUN6QyxNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsY0FBYyxDQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsR0FBRyxDQUFDO1FBQzVELElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxPQUFPO2dCQUNMLFVBQVUsRUFBRSxHQUFHO2dCQUNmLE9BQU8sRUFBRTtvQkFDUCw2QkFBNkIsRUFBRSwyQkFBMkI7b0JBQzFELDhCQUE4QixFQUFFLDRCQUE0QjtpQkFDN0Q7Z0JBQ0QsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsY0FBYyxFQUFFLENBQUM7YUFDaEQsQ0FBQztTQUNIO1FBRUQsTUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQztRQUNwQyxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDO1FBRWhDLDZDQUE2QztRQUM3QyxNQUFNLGVBQWUsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQzdELE1BQU0sVUFBVSxHQUFHLEdBQUcsWUFBWSxHQUFHLGVBQWUsR0FBRyxDQUFDO1FBRXhELFFBQVEsR0FBRyxVQUFV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SDtBQUNILENBQUM7QUFFRCxTQUFTLGNBQWM7SUFDckIsT0FBTyxRQUFRLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztBQUN6RSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgUzNDbGllbnQsIEdldE9iamVjdENvbW1hbmQsIFB1dE9iamVjdENvbW1hbmQsIERlbGV0ZU9iamVjdENvbW1hbmQsIExpc3RPYmplY3RzVjJDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcbmltcG9ydCB7IGdldFNpZ25lZFVybCB9IGZyb20gJ0Bhd3Mtc2RrL3MzLXJlcXVlc3QtcHJlc2lnbmVyJztcblxuY29uc3QgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfSk7XG5jb25zdCBOT1RFU19CVUNLRVQgPSBwcm9jZXNzLmVudi5OT1RFU19CVUNLRVQhO1xuY29uc3QgTk9URVNfUFJFRklYID0gcHJvY2Vzcy5lbnYuTk9URVNfUFJFRklYIHx8ICcnO1xuXG5pbnRlcmZhY2UgTm90ZSB7XG4gIGlkOiBzdHJpbmc7XG4gIHRpdGxlOiBzdHJpbmc7XG4gIGNvbnRlbnQ6IHN0cmluZztcbiAgY3JlYXRlZEF0OiBzdHJpbmc7XG4gIHVwZGF0ZWRBdDogc3RyaW5nO1xufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xuICB0cnkge1xuICAgIC8vIEV4dHJhY3QgdXNlciBJRCBmcm9tIENvZ25pdG8gSldUIHRva2VuXG4gICAgY29uc3QgdXNlcklkID0gZXZlbnQucmVxdWVzdENvbnRleHQuYXV0aG9yaXplcj8uY2xhaW1zPy5zdWI7XG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMSxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnaHR0cHM6Ly9vdWdvdHRpLmdpdGh1Yi5pbycsXG4gICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLEF1dGhvcml6YXRpb24nLFxuICAgICAgICB9LFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgaHR0cE1ldGhvZCA9IGV2ZW50Lmh0dHBNZXRob2Q7XG4gICAgY29uc3QgcmVzb3VyY2UgPSBldmVudC5yZXNvdXJjZTtcbiAgICBcbiAgICAvLyBTYW5pdGl6ZSB1c2VyIElEIHRvIHByZXZlbnQgcGF0aCB0cmF2ZXJzYWxcbiAgICBjb25zdCBzYW5pdGl6ZWRVc2VySWQgPSB1c2VySWQucmVwbGFjZSgvW15hLXpBLVowLTktXS9nLCAnJyk7XG4gICAgY29uc3QgdXNlclByZWZpeCA9IGAke05PVEVTX1BSRUZJWH0ke3Nhbml0aXplZFVzZXJJZH0vYDtcblxuICAgIHN3aXRjaCAoYCR7aHR0cE1ldGhvZH0gJHtyZXNvdXJjZX1gKSB7XG4gICAgICBjYXNlICdHRVQgL25vdGVzJzpcbiAgICAgICAgcmV0dXJuIGF3YWl0IGxpc3ROb3Rlcyh1c2VyUHJlZml4KTtcbiAgICAgIFxuICAgICAgY2FzZSAnUE9TVCAvbm90ZXMnOlxuICAgICAgICByZXR1cm4gYXdhaXQgY3JlYXRlTm90ZSh1c2VyUHJlZml4LCBKU09OLnBhcnNlKGV2ZW50LmJvZHkgfHwgJ3t9JykpO1xuICAgICAgXG4gICAgICBjYXNlICdHRVQgL25vdGVzL3tub3RlSWR9JzpcbiAgICAgICAgcmV0dXJuIGF3YWl0IGdldE5vdGUodXNlclByZWZpeCwgZXZlbnQucGF0aFBhcmFtZXRlcnM/Lm5vdGVJZCk7XG4gICAgICBcbiAgICAgIGNhc2UgJ1BVVCAvbm90ZXMve25vdGVJZH0nOlxuICAgICAgICByZXR1cm4gYXdhaXQgdXBkYXRlTm90ZSh1c2VyUHJlZml4LCBldmVudC5wYXRoUGFyYW1ldGVycz8ubm90ZUlkLCBKU09OLnBhcnNlKGV2ZW50LmJvZHkgfHwgJ3t9JykpO1xuICAgICAgXG4gICAgICBjYXNlICdERUxFVEUgL25vdGVzL3tub3RlSWR9JzpcbiAgICAgICAgcmV0dXJuIGF3YWl0IGRlbGV0ZU5vdGUodXNlclByZWZpeCwgZXZlbnQucGF0aFBhcmFtZXRlcnM/Lm5vdGVJZCk7XG4gICAgICBcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3RhdHVzQ29kZTogNDA1LFxuICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnaHR0cHM6Ly9vdWdvdHRpLmdpdGh1Yi5pbycsXG4gICAgICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycyc6ICdDb250ZW50LVR5cGUsQXV0aG9yaXphdGlvbicsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnTWV0aG9kIG5vdCBhbGxvd2VkJyB9KSxcbiAgICAgICAgfTtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3I6JywgZXJyb3IpO1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnaHR0cHM6Ly9vdWdvdHRpLmdpdGh1Yi5pbycsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxBdXRob3JpemF0aW9uJyxcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyB9KSxcbiAgICB9O1xuICB9XG59O1xuXG5hc3luYyBmdW5jdGlvbiBsaXN0Tm90ZXModXNlclByZWZpeDogc3RyaW5nKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBMaXN0T2JqZWN0c1YyQ29tbWFuZCh7XG4gICAgQnVja2V0OiBOT1RFU19CVUNLRVQsXG4gICAgUHJlZml4OiB1c2VyUHJlZml4LFxuICB9KTtcblxuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHMzQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIGNvbnN0IG5vdGVzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgKHJlc3BvbnNlLkNvbnRlbnRzIHx8IFtdKS5tYXAoYXN5bmMgKG9iamVjdCkgPT4ge1xuICAgICAgY29uc3Qgbm90ZUlkID0gb2JqZWN0LktleSEucmVwbGFjZSh1c2VyUHJlZml4LCAnJykucmVwbGFjZSgnLmpzb24nLCAnJyk7XG4gICAgICBjb25zdCBnZXRDb21tYW5kID0gbmV3IEdldE9iamVjdENvbW1hbmQoe1xuICAgICAgICBCdWNrZXQ6IE5PVEVTX0JVQ0tFVCxcbiAgICAgICAgS2V5OiBvYmplY3QuS2V5ISxcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICBjb25zdCBub3RlUmVzcG9uc2UgPSBhd2FpdCBzM0NsaWVudC5zZW5kKGdldENvbW1hbmQpO1xuICAgICAgY29uc3Qgbm90ZUNvbnRlbnQgPSBhd2FpdCBub3RlUmVzcG9uc2UuQm9keSEudHJhbnNmb3JtVG9TdHJpbmcoKTtcbiAgICAgIGNvbnN0IG5vdGUgPSBKU09OLnBhcnNlKG5vdGVDb250ZW50KTtcbiAgICAgIFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaWQ6IG5vdGVJZCxcbiAgICAgICAgdGl0bGU6IG5vdGUudGl0bGUsXG4gICAgICAgIGNyZWF0ZWRBdDogbm90ZS5jcmVhdGVkQXQsXG4gICAgICAgIHVwZGF0ZWRBdDogbm90ZS51cGRhdGVkQXQsXG4gICAgICB9O1xuICAgIH0pXG4gICk7XG5cbiAgcmV0dXJuIHtcbiAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgaGVhZGVyczoge1xuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICdodHRwczovL291Z290dGkuZ2l0aHViLmlvJyxcbiAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxBdXRob3JpemF0aW9uJyxcbiAgICB9LFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgbm90ZXMgfSksXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZU5vdGUodXNlclByZWZpeDogc3RyaW5nLCBub3RlRGF0YTogUGFydGlhbDxOb3RlPik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIGNvbnN0IG5vdGVJZCA9IGdlbmVyYXRlTm90ZUlkKCk7XG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgXG4gIGNvbnN0IG5vdGU6IE5vdGUgPSB7XG4gICAgaWQ6IG5vdGVJZCxcbiAgICB0aXRsZTogbm90ZURhdGEudGl0bGUgfHwgJ1VudGl0bGVkJyxcbiAgICBjb250ZW50OiBub3RlRGF0YS5jb250ZW50IHx8ICcnLFxuICAgIGNyZWF0ZWRBdDogbm93LFxuICAgIHVwZGF0ZWRBdDogbm93LFxuICB9O1xuXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgUHV0T2JqZWN0Q29tbWFuZCh7XG4gICAgQnVja2V0OiBOT1RFU19CVUNLRVQsXG4gICAgS2V5OiBgJHt1c2VyUHJlZml4fSR7bm90ZUlkfS5qc29uYCxcbiAgICBCb2R5OiBKU09OLnN0cmluZ2lmeShub3RlKSxcbiAgICBDb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICB9KTtcblxuICBhd2FpdCBzM0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuXG4gIHJldHVybiB7XG4gICAgc3RhdHVzQ29kZTogMjAxLFxuICAgIGhlYWRlcnM6IHtcbiAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnaHR0cHM6Ly9vdWdvdHRpLmdpdGh1Yi5pbycsXG4gICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycyc6ICdDb250ZW50LVR5cGUsQXV0aG9yaXphdGlvbicsXG4gICAgfSxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IG5vdGUgfSksXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldE5vdGUodXNlclByZWZpeDogc3RyaW5nLCBub3RlSWQ/OiBzdHJpbmcpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xuICBpZiAoIW5vdGVJZCkge1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnaHR0cHM6Ly9vdWdvdHRpLmdpdGh1Yi5pbycsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxBdXRob3JpemF0aW9uJyxcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnTm90ZSBJRCBpcyByZXF1aXJlZCcgfSksXG4gICAgfTtcbiAgfVxuXG4gIC8vIFNhbml0aXplIG5vdGUgSURcbiAgY29uc3Qgc2FuaXRpemVkTm90ZUlkID0gbm90ZUlkLnJlcGxhY2UoL1teYS16QS1aMC05LV0vZywgJycpO1xuXG4gIHRyeSB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRPYmplY3RDb21tYW5kKHtcbiAgICAgIEJ1Y2tldDogTk9URVNfQlVDS0VULFxuICAgICAgS2V5OiBgJHt1c2VyUHJlZml4fSR7c2FuaXRpemVkTm90ZUlkfS5qc29uYCxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgczNDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBjb25zdCBub3RlQ29udGVudCA9IGF3YWl0IHJlc3BvbnNlLkJvZHkhLnRyYW5zZm9ybVRvU3RyaW5nKCk7XG4gICAgY29uc3Qgbm90ZSA9IEpTT04ucGFyc2Uobm90ZUNvbnRlbnQpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICdodHRwczovL291Z290dGkuZ2l0aHViLmlvJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLEF1dGhvcml6YXRpb24nLFxuICAgICAgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgbm90ZSB9KSxcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgaWYgKGVycm9yLm5hbWUgPT09ICdOb1N1Y2hLZXknKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiA0MDQsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJ2h0dHBzOi8vb3Vnb3R0aS5naXRodWIuaW8nLFxuICAgICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxBdXRob3JpemF0aW9uJyxcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ05vdGUgbm90IGZvdW5kJyB9KSxcbiAgICAgIH07XG4gICAgfVxuICAgIHRocm93IGVycm9yO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZU5vdGUodXNlclByZWZpeDogc3RyaW5nLCBub3RlSWQ/OiBzdHJpbmcsIG5vdGVEYXRhPzogUGFydGlhbDxOb3RlPik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIGlmICghbm90ZUlkKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICdodHRwczovL291Z290dGkuZ2l0aHViLmlvJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLEF1dGhvcml6YXRpb24nLFxuICAgICAgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdOb3RlIElEIGlzIHJlcXVpcmVkJyB9KSxcbiAgICB9O1xuICB9XG5cbiAgLy8gU2FuaXRpemUgbm90ZSBJRFxuICBjb25zdCBzYW5pdGl6ZWROb3RlSWQgPSBub3RlSWQucmVwbGFjZSgvW15hLXpBLVowLTktXS9nLCAnJyk7XG5cbiAgdHJ5IHtcbiAgICAvLyBHZXQgZXhpc3Rpbmcgbm90ZVxuICAgIGNvbnN0IGdldENvbW1hbmQgPSBuZXcgR2V0T2JqZWN0Q29tbWFuZCh7XG4gICAgICBCdWNrZXQ6IE5PVEVTX0JVQ0tFVCxcbiAgICAgIEtleTogYCR7dXNlclByZWZpeH0ke3Nhbml0aXplZE5vdGVJZH0uanNvbmAsXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHMzQ2xpZW50LnNlbmQoZ2V0Q29tbWFuZCk7XG4gICAgY29uc3Qgbm90ZUNvbnRlbnQgPSBhd2FpdCByZXNwb25zZS5Cb2R5IS50cmFuc2Zvcm1Ub1N0cmluZygpO1xuICAgIGNvbnN0IGV4aXN0aW5nTm90ZSA9IEpTT04ucGFyc2Uobm90ZUNvbnRlbnQpO1xuXG4gICAgLy8gVXBkYXRlIG5vdGVcbiAgICBjb25zdCB1cGRhdGVkTm90ZTogTm90ZSA9IHtcbiAgICAgIC4uLmV4aXN0aW5nTm90ZSxcbiAgICAgIC4uLm5vdGVEYXRhLFxuICAgICAgaWQ6IGV4aXN0aW5nTm90ZS5pZCwgLy8gUHJldmVudCBJRCBjaGFuZ2VcbiAgICAgIGNyZWF0ZWRBdDogZXhpc3RpbmdOb3RlLmNyZWF0ZWRBdCwgLy8gUHJldmVudCBjcmVhdGlvbiBkYXRlIGNoYW5nZVxuICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgfTtcblxuICAgIGNvbnN0IHB1dENvbW1hbmQgPSBuZXcgUHV0T2JqZWN0Q29tbWFuZCh7XG4gICAgICBCdWNrZXQ6IE5PVEVTX0JVQ0tFVCxcbiAgICAgIEtleTogYCR7dXNlclByZWZpeH0ke3Nhbml0aXplZE5vdGVJZH0uanNvbmAsXG4gICAgICBCb2R5OiBKU09OLnN0cmluZ2lmeSh1cGRhdGVkTm90ZSksXG4gICAgICBDb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgIH0pO1xuXG4gICAgYXdhaXQgczNDbGllbnQuc2VuZChwdXRDb21tYW5kKTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnaHR0cHM6Ly9vdWdvdHRpLmdpdGh1Yi5pbycsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxBdXRob3JpemF0aW9uJyxcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IG5vdGU6IHVwZGF0ZWROb3RlIH0pLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBpZiAoZXJyb3IubmFtZSA9PT0gJ05vU3VjaEtleScpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwNCxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnaHR0cHM6Ly9vdWdvdHRpLmdpdGh1Yi5pbycsXG4gICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLEF1dGhvcml6YXRpb24nLFxuICAgICAgICB9LFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnTm90ZSBub3QgZm91bmQnIH0pLFxuICAgICAgfTtcbiAgICB9XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZGVsZXRlTm90ZSh1c2VyUHJlZml4OiBzdHJpbmcsIG5vdGVJZD86IHN0cmluZyk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIGlmICghbm90ZUlkKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICdodHRwczovL291Z290dGkuZ2l0aHViLmlvJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLEF1dGhvcml6YXRpb24nLFxuICAgICAgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdOb3RlIElEIGlzIHJlcXVpcmVkJyB9KSxcbiAgICB9O1xuICB9XG5cbiAgLy8gU2FuaXRpemUgbm90ZSBJRFxuICBjb25zdCBzYW5pdGl6ZWROb3RlSWQgPSBub3RlSWQucmVwbGFjZSgvW15hLXpBLVowLTktXS9nLCAnJyk7XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IERlbGV0ZU9iamVjdENvbW1hbmQoe1xuICAgICAgQnVja2V0OiBOT1RFU19CVUNLRVQsXG4gICAgICBLZXk6IGAke3VzZXJQcmVmaXh9JHtzYW5pdGl6ZWROb3RlSWR9Lmpzb25gLFxuICAgIH0pO1xuXG4gICAgYXdhaXQgczNDbGllbnQuc2VuZChjb21tYW5kKTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDQsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnaHR0cHM6Ly9vdWdvdHRpLmdpdGh1Yi5pbycsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxBdXRob3JpemF0aW9uJyxcbiAgICAgIH0sXG4gICAgICBib2R5OiAnJyxcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGRlbGV0aW5nIG5vdGU6JywgZXJyb3IpO1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnaHR0cHM6Ly9vdWdvdHRpLmdpdGh1Yi5pbycsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxBdXRob3JpemF0aW9uJyxcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnRmFpbGVkIHRvIGRlbGV0ZSBub3RlJyB9KSxcbiAgICB9O1xuICB9XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlTm90ZUlkKCk6IHN0cmluZyB7XG4gIHJldHVybiBgbm90ZS0ke0RhdGUubm93KCl9LSR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWA7XG59Il19